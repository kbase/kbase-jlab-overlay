name: Build Wheel

on:
  release:
    types: [published, prereleased]
  workflow_call:
    inputs:
      release_tag:
        type: string
        required: true

jobs:
  build_and_attach:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Remove prerelease tags (not PEP 440 valid, breaks hatch-vcs)
        run: git tag -l '*-pr*' | xargs -r git tag -d

      - uses: jupyterlab/maintainer-tools/.github/actions/base-setup@v1

      - name: Install dependencies
        run: python -m pip install -U "jupyterlab>=4.0.0,<5"

      - name: Build the extension
        run: |
          set -eux
          jlpm
          jlpm run build:prod

      - name: Build wheel
        run: |
          set -eux
          pip install build
          python -m build --wheel

      - name: Determine release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "value=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "value=${{ inputs.release_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload wheel to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ steps.tag.outputs.value }}" \
            dist/*.whl --clobber
